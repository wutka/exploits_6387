port module Exploits exposing (main)

import Array exposing (Array)
import Browser
import Html exposing (..)
import Html.Attributes exposing (..)
import Json.Decode exposing (..)

type Msg 
  = IncomingMsg String

type alias Instruction =
  {
    address : Int
  , instruction : String
  }

instructionDecoder : Decoder Instruction
instructionDecoder =
  map2 Instruction (field "Address" int) (field "Instruction" string)

type alias Register =
  {
    name : String
  , value : Int
  }

registerDecoder : Decoder Register
registerDecoder =
  map2 Register (field "Name" string) (field "Value" int)

type alias MemoryRange =
  {
    start : Int
  , end : Int
  }

memoryRangeDecoder : Decoder MemoryRange
memoryRangeDecoder =
  map2 MemoryRange (field "Start" int) (field "End" int)

type alias MemoryMap =
  {
    execStart : Int
  , execEnd : Int
  , dataStart : Int
  , dataEnd : Int
  , stackStart : Int
  , stackEnd : Int
  , ranges : List MemoryRange
  }

memoryMapDecoder : Decoder MemoryMap
memoryMapDecoder =
  map7 MemoryMap (field "ExecStart" int) (field "ExecEnd" int)
       (field "DataStart" int) (field "DataEnd" int)
       (field "StackStart" int) (field "StackEnd" int)
       (field "Ranges" (Json.Decode.list memoryRangeDecoder))

type alias MachineState =
  {
    instructions : Array Instruction
  , registers : Array Register
  , memoryMap : MemoryMap
  }

machineStateDecoder : Decoder MachineState
machineStateDecoder =
  map3 MachineState
       (field "Instructions" (array instructionDecoder))
       (field "Registers" (array registerDecoder))
       (field "MemoryMap" memoryMapDecoder)

type alias Model =
  {
    instructions : List Instruction
  , registers : List Register
  , memoryMap : MemoryMap
  }

type alias MessageWrapper =
  {
    messageType : String
  , messageBody : String
  }

messageWrapperDecoder : Decoder MessageWrapper
messageWrapperDecoder =
  map2 MessageWrapper (field "MessageType" string) (field "MessageBody" string)

initialModel =
  {
    instructions = []
  , registers = []
  , memoryMap =
    {
      execStart = 0
    , execEnd = 0
    , dataStart = 0
    , dataEnd = 0
    , stackStart = 0
    , stackEnd = 0
    , ranges = []
    }
  }

port websocketIn : (String -> msg) -> Sub msg
port websocketOut : String -> Cmd msg

viewDisassembled inst =
    pre [class "code"] [text inst]
    
view model =
    div [] [ div [] [
                      div [id "disasm", class "disasmgrid"] 
                        (List.map viewDisassembled model.instructions)
                    , div [id "registers", class "reggrid"] []
                    ]
           , div [] [
                      div [id "memory", class "memgrid"] []
                    , div [id "command", class "cmdgrid"] []
                    ]
           ]

update msg model = model

readWebsocketMessage : String -> Sub MessageWrapper
readWebsocketMessage str = (messageWrapperDecoder str)

subscriptions : Model -> Sub MessageWrapper
subscriptions model =
    websocketIn readWebsocketMessage

main = Browser.element
    { init = initialModel
    , view = view
    , update = update
    , subscriptions = subscriptions
    }

