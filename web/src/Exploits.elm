port module Exploits exposing (main)

import Array exposing (Array)
import Browser
import Html exposing (..)
import Html.Attributes exposing (..)
import Json.Decode exposing (..)
import Debug

type Msg 
  = IncomingMsg String

type alias Instruction =
  {
    address : Int
  , instruction : String
  }

instructionDecoder : Decoder Instruction
instructionDecoder =
  map2 Instruction (field "Address" int) (field "Instruction" string)

type alias Register =
  {
    name : String
  , value : Int
  }

registerDecoder : Decoder Register
registerDecoder =
  map2 Register (field "Name" string) (field "Value" int)

type alias MemoryRange =
  {
    start : Int
  , end : Int
  }

memoryRangeDecoder : Decoder MemoryRange
memoryRangeDecoder =
  map2 MemoryRange (field "Start" int) (field "End" int)

type alias MemoryMap =
  {
    execStart : Int
  , execEnd : Int
  , dataStart : Int
  , dataEnd : Int
  , stackStart : Int
  , stackEnd : Int
  , ranges : List MemoryRange
  }

memoryMapDecoder : Decoder MemoryMap
memoryMapDecoder =
  map7 MemoryMap (field "ExecStart" int) (field "ExecEnd" int)
       (field "DataStart" int) (field "DataEnd" int)
       (field "StackStart" int) (field "StackEnd" int)
       (field "Ranges" (Json.Decode.list memoryRangeDecoder))

type alias MachineState =
  {
    instructions : Array Instruction
  , registers : Array Register
  , memoryMap : MemoryMap
  }

machineStateDecoder : Decoder MachineState
machineStateDecoder =
  map3 MachineState
       (field "Instructions" (array instructionDecoder))
       (field "Registers" (array registerDecoder))
       (field "MemoryMap" memoryMapDecoder)

type alias TargetConfig =
  {
    title : String
  , targetName : String
  }

targetConfigDecoder : Decoder TargetConfig
targetConfigDecoder =
  map2 TargetConfig
    (field "Title" string)
    (field "TargetName" string)

type alias Configuration =
  {
    targets : List TargetConfig
  }

configurationDecoder : Decoder Configuration
configurationDecoder =
  Json.Decode.map Configuration
    (field "Targets" (Json.Decode.list targetConfigDecoder))

type alias Model = 
  {
    configuration : Configuration
  , machineState : MachineState
  }

type alias MessageWrapper =
  {
    messageType : String
  , messageBody : Json.Decode.Value
  }

messageWrapperDecoder : Decoder MessageWrapper
messageWrapperDecoder =
  map2 MessageWrapper (field "MessageType" string) (field "MessageBody" Json.Decode.value)

init : () -> (Model, Cmd Msg)
init _ =
  ({ machineState =
      { instructions = Array.fromList []
      , registers = Array.fromList []
      , memoryMap =
        {
          execStart = 0
        , execEnd = 0
        , dataStart = 0
        , dataEnd = 0
        , stackStart = 0
        , stackEnd = 0
        , ranges = []
        }
       }
   , configuration = { targets = [] }
   }
   , Cmd.none)

port websocketIn : (String -> msg) -> Sub msg
port websocketOut : String -> Cmd msg

viewDisassembled : Instruction -> Html Msg
viewDisassembled inst =
    pre [class "code"] [text inst.instruction]
    
viewTargets : TargetConfig -> Html Msg
viewTargets targetConfig =
  let _ = Debug.log "Writing config title" targetConfig.title
  in
    div [class "title"] [ text targetConfig.title]

view : Model -> Html Msg
view model =
  div []
    [
      div [class "titlebar"] (List.map viewTargets model.configuration.targets)
    , div [] [
        div []
          [  div [] [
                      div [id "disasm", class "disasmgrid"] 
                        (List.map viewDisassembled
                            (Array.toList model.machineState.instructions))
                    , div [id "registers", class "reggrid"] []
                    ]
           , div [] [
                      div [id "memory", class "memgrid"] []
                    , div [id "command", class "cmdgrid"] []
                    ]
          ]
        ]
    ]

handleMachineState model machineState = { model | machineState = machineState }
handleConfiguration model configuration = { model | configuration = configuration }

handleIncomingMessage : Model -> MessageWrapper -> Model
handleIncomingMessage model messageWrapper =
  let
    _ = Debug.log "" "Handling incoming message"
    dispatcher decoder handler =
      case Json.Decode.decodeValue decoder messageWrapper.messageBody of
          Ok data -> handler model data
          Err mess -> let _ = Debug.log "Error decoding message body" mess
                   in
                     model
  
    _ = Debug.log "" ("Received message of type "++messageWrapper.messageType)
  in
    case messageWrapper.messageType of
      "MachineState" -> dispatcher machineStateDecoder handleMachineState
      "Configuration" -> dispatcher configurationDecoder handleConfiguration
      _ -> let _ = Debug.log "" ("Received unknown message type "++messageWrapper.messageType)
           in
             model

update msg model = 
    case msg of
        IncomingMsg payload ->
            case Json.Decode.decodeString messageWrapperDecoder payload of
                Ok messageWrapper -> (handleIncomingMessage model messageWrapper, Cmd.none)
                Err message ->
                  let _ = Debug.log "Error decoding message wrapper" message
                  in
                    (model, Cmd.none)

subscriptions : Model -> Sub Msg
subscriptions _ =
  websocketIn IncomingMsg

main : Program () Model Msg
main = 
  Browser.element
    { init = init
    , view = view
    , update = update
    , subscriptions = subscriptions
    }

