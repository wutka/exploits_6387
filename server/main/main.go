package main

import (
	"encoding/json"
	"fmt"
	"github.com/wutka/exploits_6387/server"
	"io/ioutil"
	"runtime"
)

var config server.Config
var procConfig server.ProcConfig

func main() {

	configBytes, err := ioutil.ReadFile("config.json")
	if err != nil {
		fmt.Printf("Error reading configuration: %+v\n", err)
		return
	}

	err = json.Unmarshal(configBytes, &config)
	if err != nil {
		fmt.Printf("Error decoding config json: %+v\n", err)
		return
	}

	procConfigBytes, err := ioutil.ReadFile("processors.json")
	if err != nil {
		fmt.Printf("Error reading processor configuration: %+v\n", err)
		return
	}

	err = json.Unmarshal(procConfigBytes, &procConfig)
	if err != nil {
		fmt.Printf("Error decoding processor config json: %+v\n", err)
		return
	}

	processorConfig, ok := procConfig.Processors[runtime.GOARCH]
	if !ok {
		fmt.Printf("Unsupported processor architecture: %s\n", runtime.GOARCH)
		fmt.Printf("%+v\n", procConfig)
		return
	}

	server.RunApplication(config, processorConfig)
	/*
		sess, err := server.NewSession("target1")
		if err != nil {
			fmt.Printf("Error creating session: %+v", err)
			return
		}

		sess.Debug()
		memmap, err := sess.GetMemoryMap()
		fmt.Printf("%v\n", memmap)
		regs, err := sess.GetRegisters()
		fmt.Printf("%v\n", regs)
		dis, _ := sess.Disassemble()
		for _, d := range dis {
			fmt.Printf("%016x %s\n", d.Address, d.Instruction)
		}

		_, _ = sess.GetMemory(memmap.ExecEnd, memmap.DataEnd)

		sess.End()
	*/
}
