#include "target_lib.h"

int check_password();
void open_lock();

char *gets(char *);
int strcmp(char *c1, char *c2);

unsigned char xor_mask[] = { 0x12, 0x93, 0xf4, 0x2e, 0x77, 0x35, 0xa0, 0x82, 0x4d, 0x17, 0xcb, 0xcf, 0x22 };
unsigned char xor_password[] = { 0x5d, 0xe3, 0x91, 0x40, 0x53, 0x06, 0x84, 0xc2, 0x20, 0x24, 0 };

char prompt1[] = "Please enter lock password:";
char prompt2[] = "Invalid password, _ tries left:";

int main()
{
    if (check_password()) {
        open_lock();
    } else {
        write(1, "x", 1);
    }
}

int check_password()
{
    char password[16];
    unsigned char *mask, *pw_in, *pw_xor;
    char countstr[2];
    for (int i=0; i < 3; i++) {
        if (i == 0) {
            prompt(prompt1, sizeof(prompt1), password);
        } else {
            prompt2[18] = '0' + (3-i);
            prompt(prompt2, sizeof(prompt2), password);
        }
        pw_in = password;
        pw_xor = xor_password;
        mask = xor_mask;

        while (*pw_in && *pw_xor) {
            if (*pw_in != (*pw_xor ^ *mask++)) {
                break;
            }
            pw_in++;
            pw_xor++;
        }
        if ((*pw_in == 0) && (*pw_xor == 0)) return 1;
    }
    return 0;
}

void open_lock() {
    write(1, "!", 1);
}

