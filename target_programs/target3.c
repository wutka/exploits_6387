#include "target_lib.h"
#include "aes256.h"

int check_password();
void open_lock();

char *gets(char *);
int strcmp(char *c1, char *c2);

unsigned char aes256_key[32] = {
  0x7f, 0xae, 0xcb, 0x32, 0x63, 0x7f, 0x2d, 0x05,
  0x3a, 0x42, 0xea, 0xa8, 0x7a, 0x6b, 0x4b, 0xd3,
  0x1c, 0xa9, 0x7a, 0x45, 0x22, 0x44, 0x50, 0xbc,
  0xf3, 0x91, 0x91, 0x78, 0xf0, 0x22, 0x9a, 0xbb};

unsigned char aes256_pw[] = {
    0x4d, 0xb0, 0x7b, 0x9f, 0x3d, 0xbf, 0x4a, 0x69, 
    0x21, 0xc9, 0x48, 0xdb, 0xb8, 0x91, 0x3f, 0xe9 };

unsigned char aes256_decrypt_buffer[32];



char prompt1[] = "Please enter lock password:";
char prompt2[] = "Invalid password, _ tries left:";

int main()
{
    if (check_password()) {
        open_lock();
    } else {
        write(1, "x", 1);
    }
}

int check_password()
{
    char password[16];
    unsigned char *mask, *pw_in, *pw_xor;
    char countstr[2];
    int return_len;

    AES256MainECB(aes256_key, aes256_pw, sizeof(aes256_pw), aes256_decrypt_buffer, &return_len, false);

    for (int i=0; i < 3; i++) {
        if (i == 0) {
            prompt(prompt1, sizeof(prompt1), password);
        } else {
            prompt2[18] = '0' + (3-i);
            prompt(prompt2, sizeof(prompt2), password);
        }
        if (!strcmp(password, aes256_decrypt_buffer)) return 1;
    }
    return 0;
}

void open_lock() {
    write(1, "!", 1);
}

